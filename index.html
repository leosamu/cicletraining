<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento de Entrenamiento</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
</head>
<body>
    <h1>Seguimiento de Entrenamiento</h1>
    
    <!-- Menú de selección de entrenamiento -->
    <div id="menu-entrenamiento">
        <h2>Selecciona tu entrenamiento</h2>
        <button onclick="seleccionarEntrenamiento('4+2')">Mejora de potencia (4 días gym + 2 bici)</button>
        <button onclick="seleccionarEntrenamiento('2+1')">Mejora de potencia (2 días gym + 1 bici)</button>
    </div>
    
    <!-- Submenú de selección de rutina -->
    <div id="menu-rutina" style="display:none;">
        <h2>Selecciona tu rutina</h2>
        <div id="opciones-rutina"></div>
    </div>
    
    <!-- Contenedor para mostrar la rutina -->
    <div id="rutina" style="display:none;">
        <h2>Rutina Seleccionada</h2>
        <div id="contenido-rutina"></div>
    </div>
    
    <script>
        let rutinaActual = null;
        let archivoActual = "";
        let intervalos = {}; 

        function seleccionarEntrenamiento(tipo) {
            document.getElementById('menu-rutina').style.display = 'block';
            document.getElementById('opciones-rutina').innerHTML = '';
            
            let opciones = tipo === '4+2' ? ["Opción 1", "Opción 2", "Opción 3", "Opción 4", "Opción 5", "Opción 6"] : ["Opción 1", "Opción 2", "Opción 3"];
            opciones.forEach(opcion => {
                let btn = document.createElement('button');
                btn.textContent = opcion;
                btn.onclick = () => cargarRutina(tipo, opcion);
                document.getElementById('opciones-rutina').appendChild(btn);
            });
        }
        
        function cargarRutina(tipo, opcion) {
            document.getElementById('rutina').style.display = 'block';
            document.getElementById('contenido-rutina').innerHTML = `<p>Cargando rutina ${tipo} - ${opcion}...</p>`;
            
            archivoActual = `rutinas/${tipo.replace('+', '')}_opcion${opcion.split(' ')[1]}.yml`;
            let storedData = localStorage.getItem(archivoActual);
            
            if (storedData) {
                rutinaActual = JSON.parse(storedData);
                mostrarRutina();
            } else {
                fetch(archivoActual)
                    .then(response => response.text())
                    .then(yamlText => {
                        rutinaActual = jsyaml.load(yamlText);
                        guardarEnLocalStorage();
                        mostrarRutina();
                    })
                    .catch(error => {
                        document.getElementById('contenido-rutina').innerHTML = `<p>Error cargando la rutina.</p>`;
                        console.error("Error cargando el archivo YAML: ", error);
                    });
            }
        }
        
        function mostrarRutina() {
            let contenido = `<h3>${rutinaActual.nombre}</h3>`;
            rutinaActual.bloques.forEach((bloque, bloqueIdx) => {
                contenido += `<h4>${bloque.nombre}</h4>`;
                bloque.ejercicios.forEach((ejercicio, ejercicioIdx) => {
                    let series = ejercicio.series || 1;
                    contenido += `
                        <p>
                            ${ejercicio.nombre} - 
                            <input type="text" value="${ejercicio.peso}" onchange="actualizarValor(${bloqueIdx}, ${ejercicioIdx}, 'peso', this.value)"> kg -
                            <input type="text" value="${series}" onchange="actualizarValor(${bloqueIdx}, ${ejercicioIdx}, 'series', this.value)"> series x 
                            <input type="text" value="${ejercicio.repeticiones}" onchange="actualizarValor(${bloqueIdx}, ${ejercicioIdx}, 'repeticiones', this.value)"> repeticiones - 
                            <input type="text" value="${ejercicio.descanso}" onchange="actualizarValor(${bloqueIdx}, ${ejercicioIdx}, 'descanso', this.value)"> descanso
                            <button onclick="modificarSeries(${bloqueIdx}, ${ejercicioIdx}, -1)">-</button>
                            <span id="contador-${bloqueIdx}-${ejercicioIdx}">0/${series}</span>
                            <button onclick="modificarSeries(${bloqueIdx}, ${ejercicioIdx}, 1)">+</button>
                            <span id="estado-${bloqueIdx}-${ejercicioIdx}"></span>
                        </p>`;
                });
            });
            document.getElementById('contenido-rutina').innerHTML = contenido;
        }

        function modificarSeries(bloqueIdx, ejercicioIdx, cambio) {
            let ejercicio = rutinaActual.bloques[bloqueIdx].ejercicios[ejercicioIdx];
            let series = ejercicio.series || 1;
            let contador = document.getElementById(`contador-${bloqueIdx}-${ejercicioIdx}`);
            let estado = document.getElementById(`estado-${bloqueIdx}-${ejercicioIdx}`);
            let valorActual = parseInt(contador.textContent.split('/')[0]);
            let nuevoValor = Math.max(0, Math.min(series, valorActual + cambio));
            contador.textContent = `${nuevoValor}/${series}`;
            estado.innerHTML = "";
            
            if (intervalos[`${bloqueIdx}-${ejercicioIdx}`]) {
                clearTimeout(intervalos[`${bloqueIdx}-${ejercicioIdx}`]);
            }
            
            if (nuevoValor > 0 && nuevoValor < series) {
                let descanso = parseInt(ejercicio.descanso) * 1000;
                estado.innerHTML = "⏳";
                intervalos[`${bloqueIdx}-${ejercicioIdx}`] = setTimeout(() => {
                    new Audio('beep.mp3').play();
                    estado.innerHTML = "✅";
                }, descanso);
            }
            
            if (nuevoValor === series) {
                contador.style.color = 'green';
            } else {
                contador.style.color = 'black';
            }
        }
    </script>
</body>
</html>
